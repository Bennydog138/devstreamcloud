<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevStream | Cloud Developer Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-transition { transition: all 0.2s ease-in-out; }
        .btn-transition:active { transform: scale(0.98); }
        .loading-overlay {
            position: fixed; inset: 0; background: white; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <div id="loading" class="loading-overlay">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-slate-500 font-medium text-center px-4">Connecting to DevStream Cloud...</p>
        </div>
    </div>

    <div id="app">
        <!-- Auth Section -->
        <div id="login-screen" class="flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 border border-slate-200">
                <div class="text-center mb-8">
                    <div class="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-200">
                        <i class="fas fa-cloud text-white text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-800">DevStream Cloud</h1>
                    <p class="text-slate-500">Shared workspace for developers</p>
                </div>

                <div id="config-warning" class="hidden mb-6 text-amber-600 text-sm bg-amber-50 p-4 rounded-xl border border-amber-200">
                    <div class="flex gap-3">
                        <i class="fas fa-exclamation-triangle mt-1"></i>
                        <div>
                            <p class="font-bold">Authentication Config Error</p>
                            <p class="mt-1 opacity-90">Your Firebase environment is not ready for authentication. Please:</p>
                            <ol class="list-decimal ml-4 mt-2 space-y-1 opacity-90">
                                <li>Open <strong>Firebase Console</strong></li>
                                <li>Go to <strong>Authentication</strong> &gt; <strong>Sign-in method</strong></li>
                                <li>Enable <strong>Anonymous</strong> and save changes</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Username</label>
                        <input type="text" id="username" required class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                        <input type="password" id="password" required class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                    <div id="login-error" class="hidden text-red-500 text-sm bg-red-50 p-3 rounded-lg border border-red-100"></div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl shadow-md btn-transition">
                        Sign In
                    </button>
                </form>
                <p class="mt-6 text-center text-xs text-slate-400">Default Admin: admin / admin123</p>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="main-dashboard" class="hidden">
            <nav class="fixed top-0 left-0 h-full w-64 bg-slate-900 text-white hidden lg:flex flex-col z-50">
                <div class="p-6 flex items-center gap-3">
                    <div class="bg-indigo-500 p-2 rounded-lg"><i class="fas fa-terminal"></i></div>
                    <span class="text-xl font-bold">DevStream</span>
                </div>
                <div class="flex-1 px-4 space-y-2 mt-4">
                    <button onclick="showView('overview')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-colors" data-view="overview">
                        <i class="fas fa-home opacity-70"></i> Dashboard
                    </button>
                    <button id="nav-users" onclick="showView('users')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-colors" data-view="users">
                        <i class="fas fa-users opacity-70"></i> Team
                    </button>
                    <button onclick="showView('tasks')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-colors" data-view="tasks">
                        <i class="fas fa-tasks opacity-70"></i> Tasks
                    </button>
                </div>
                <div class="p-4 border-t border-slate-800">
                    <div class="flex items-center gap-3 px-4 py-3">
                        <div id="user-avatar" class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-xs uppercase"></div>
                        <div class="flex-1 overflow-hidden">
                            <p id="user-display-name" class="text-sm font-medium truncate"></p>
                            <p id="user-display-role" class="text-xs text-slate-400 truncate"></p>
                        </div>
                        <button onclick="logout()" class="text-slate-400 hover:text-red-400 transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </nav>

            <main class="lg:ml-64 p-4 md:p-8">
                <header class="flex justify-between items-center mb-8">
                    <div>
                        <h2 id="view-title" class="text-2xl font-bold text-slate-800">Overview</h2>
                        <p id="view-subtitle" class="text-slate-500">Live cloud workspace</p>
                    </div>
                </header>

                <div id="view-content">
                    <!-- Dashboard Cards -->
                    <div id="view-overview" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <h3 class="text-slate-500 text-xs font-bold uppercase mb-2">Pending Tasks</h3>
                                <p id="stat-tasks" class="text-3xl font-bold text-slate-800">0</p>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <h3 class="text-slate-500 text-xs font-bold uppercase mb-2">Completed</h3>
                                <p id="stat-completed" class="text-3xl font-bold text-slate-800">0</p>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <h3 class="text-slate-500 text-xs font-bold uppercase mb-2">Active Devs</h3>
                                <p id="stat-users" class="text-3xl font-bold text-slate-800">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- User Table -->
                    <div id="view-users" class="hidden space-y-6">
                        <div class="flex justify-end">
                            <button onclick="toggleModal('user-modal', true)" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-medium btn-transition">
                                <i class="fas fa-plus mr-2"></i> Add Team Member
                            </button>
                        </div>
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                                    <tr>
                                        <th class="px-6 py-4">User</th>
                                        <th class="px-6 py-4">Role</th>
                                        <th class="px-6 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="text-sm divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Task List -->
                    <div id="view-tasks" class="hidden space-y-6">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-slate-700">Project Backlog</h3>
                            <button id="btn-add-task" onclick="toggleModal('task-modal', true)" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-medium btn-transition">
                                <i class="fas fa-plus mr-2"></i> New Task
                            </button>
                        </div>
                        <div class="grid grid-cols-1 gap-4" id="tasks-list"></div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modals -->
        <div id="user-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between">
                    <h3 class="font-bold">Add Team Member</h3>
                    <button onclick="toggleModal('user-modal', false)"><i class="fas fa-times"></i></button>
                </div>
                <form id="user-form" class="p-6 space-y-4">
                    <input type="text" id="new-name" placeholder="Full Name" required class="w-full px-4 py-2 border rounded-xl">
                    <input type="text" id="new-username" placeholder="Username" required class="w-full px-4 py-2 border rounded-xl">
                    <input type="password" id="new-password" placeholder="Password" required class="w-full px-4 py-2 border rounded-xl">
                    <select id="new-role" class="w-full px-4 py-2 border rounded-xl bg-white">
                        <option value="developer">Developer</option>
                        <option value="admin">Super Admin</option>
                    </select>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Create User</button>
                </form>
            </div>
        </div>

        <div id="task-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between">
                    <h3 class="font-bold">Assign Task</h3>
                    <button onclick="toggleModal('task-modal', false)"><i class="fas fa-times"></i></button>
                </div>
                <form id="task-form" class="p-6 space-y-4">
                    <input type="text" id="task-title" placeholder="Title" required class="w-full px-4 py-2 border rounded-xl">
                    <select id="task-assignee" required class="w-full px-4 py-2 border rounded-xl bg-white"></select>
                    <textarea id="task-desc" placeholder="Details..." rows="3" required class="w-full px-4 py-2 border rounded-xl"></textarea>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Assign</button>
                </form>
            </div>
        </div>

        <div id="upload-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between">
                    <h3 class="font-bold">Submit Work</h3>
                    <button onclick="toggleModal('upload-modal', false)"><i class="fas fa-times"></i></button>
                </div>
                <form id="submission-form" class="p-6 space-y-4">
                    <input type="hidden" id="submit-task-id">
                    <input type="file" id="submission-file" class="w-full p-4 border-2 border-dashed rounded-xl">
                    <textarea id="submission-notes" placeholder="Notes..." class="w-full px-4 py-2 border rounded-xl"></textarea>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold">Mark as Done</button>
                </form>
            </div>
        </div>

        <div id="toast" class="fixed bottom-4 right-4 translate-y-20 transition-transform bg-slate-900 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 z-[200]">
            <span id="toast-message"></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, onSnapshot, query, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWuHXU4foFgeyDLnhj2PPgHIJzzyGpXxY",
            authDomain: "deve-6eead.firebaseapp.com",
            projectId: "deve-6eead",
            storageBucket: "deve-6eead.firebasestorage.app",
            messagingSenderId: "135058445868",
            appId: "1:135058445868:web:389198731d37457ca72389",
            measurementId: "G-H4X31MRL6B"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'deve-6eead-portal';

        let currentUserData = null;
        let allUsers = [];
        let allTasks = [];

        const initAuth = async () => {
            try {
                // Rule 3: Auth BEFORE any queries
                // Improved logic to prevent custom-token-mismatch errors
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && __initial_auth_token !== "") {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (tokenErr) {
                        console.warn("Custom token failed, falling back to Anonymous:", tokenErr);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth failed definitively:", err);
                if (err.code === 'auth/configuration-not-found' || err.code === 'auth/operation-not-allowed') {
                    document.getElementById('config-warning').classList.remove('hidden');
                }
                document.getElementById('loading').classList.add('hidden');
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                setupRealtimeListeners();
                document.getElementById('loading').classList.add('hidden');
            }
        });

        function setupRealtimeListeners() {
            // Rule 1: Strict collection paths
            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            const tasksRef = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');

            onSnapshot(usersRef, (snapshot) => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (allUsers.length === 0) createDefaultAdmin();
                if (window.APP?.currentView === 'users') renderUsers();
                updateStats();
                updateAssigneeDropdown();
            }, (err) => {
                console.error("Firestore Users Error:", err);
                showToast("Database access error");
            });

            onSnapshot(tasksRef, (snapshot) => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (window.APP?.currentView === 'tasks') renderTasks();
                if (window.APP?.currentView === 'overview') renderOverview();
                updateStats();
            }, (err) => console.error("Firestore Tasks Error:", err));
        }

        async function createDefaultAdmin() {
            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            await addDoc(usersRef, {
                name: 'Super Admin',
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                created: new Date().toISOString()
            });
        }

        window.APP = { currentView: 'overview' };

        window.showView = (viewId) => {
            window.APP.currentView = viewId;
            ['overview', 'users', 'tasks'].forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if (el) el.classList.add('hidden');
            });
            const targetEl = document.getElementById(`view-${viewId}`);
            if (targetEl) targetEl.classList.remove('hidden');
            
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.dataset.view === viewId) {
                    link.classList.add('bg-indigo-600', 'text-white');
                } else {
                    link.classList.remove('bg-indigo-600', 'text-white');
                }
            });

            if (viewId === 'overview') renderOverview();
            if (viewId === 'users') renderUsers();
            if (viewId === 'tasks') renderTasks();
        };

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const usernameInput = document.getElementById('username').value;
            const passwordInput = document.getElementById('password').value;
            
            const user = allUsers.find(u => 
                u.username === usernameInput && 
                u.password === passwordInput
            );

            if (user) {
                currentUserData = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-dashboard').classList.remove('hidden');
                initDashboard();
                showToast(`Welcome back, ${user.name}`);
            } else {
                const err = document.getElementById('login-error');
                err.innerText = "Invalid credentials";
                err.classList.remove('hidden');
            }
        });

        window.logout = () => {
            currentUserData = null;
            document.getElementById('main-dashboard').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        };

        function initDashboard() {
            const isAdmin = currentUserData.role === 'admin';
            document.getElementById('nav-users').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('btn-add-task').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('user-display-name').innerText = currentUserData.name;
            document.getElementById('user-display-role').innerText = currentUserData.role;
            document.getElementById('user-avatar').innerText = currentUserData.name[0];
            showView('overview');
        }

        function renderOverview() { updateStats(); }

        function updateStats() {
            const pending = allTasks.filter(t => t.status === 'pending').length;
            const done = allTasks.filter(t => t.status === 'completed').length;
            if (document.getElementById('stat-tasks')) document.getElementById('stat-tasks').innerText = pending;
            if (document.getElementById('stat-completed')) document.getElementById('stat-completed').innerText = done;
            if (document.getElementById('stat-users')) document.getElementById('stat-users').innerText = allUsers.length;
        }

        function renderUsers() {
            const body = document.getElementById('users-table-body');
            body.innerHTML = allUsers.map(u => `
                <tr>
                    <td class="px-6 py-4 font-bold">${u.name} <span class="text-xs font-normal text-slate-400">@${u.username}</span></td>
                    <td class="px-6 py-4 capitalize text-slate-500">${u.role}</td>
                    <td class="px-6 py-4 text-right">
                        ${u.username !== 'admin' ? `<button onclick="deleteUser('${u.id}')" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function renderTasks() {
            const list = document.getElementById('tasks-list');
            const isAdmin = currentUserData.role === 'admin';
            const tasks = isAdmin ? allTasks : allTasks.filter(t => t.assigneeId === currentUserData.id);

            list.innerHTML = tasks.length ? tasks.map(t => `
                <div class="bg-white p-6 rounded-2xl border shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <span class="text-[10px] font-bold uppercase px-2 py-1 rounded ${t.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">${t.status}</span>
                        <h4 class="text-lg font-bold text-slate-800">${t.title}</h4>
                        <p class="text-slate-500 text-sm">${t.desc}</p>
                        <div class="text-xs text-slate-400 mt-2">Assigned to: ${t.assigneeName}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        ${t.status === 'completed' ? `
                            <button onclick="downloadWork('${t.fileName}')" class="bg-slate-100 px-4 py-2 rounded-xl text-sm font-bold"><i class="fas fa-eye mr-1"></i> View</button>
                        ` : (isAdmin ? `
                            <button onclick="deleteTask('${t.id}')" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        ` : `
                            <button onclick="openSubmission('${t.id}')" class="bg-green-600 text-white px-4 py-2 rounded-xl text-sm font-bold">Submit</button>
                        `)}
                    </div>
                </div>
            `).join('') : '<div class="text-center py-12 text-slate-400">No tasks found.</div>';
        }

        function updateAssigneeDropdown() {
            const sel = document.getElementById('task-assignee');
            if (!sel) return;
            sel.innerHTML = allUsers.filter(u => u.role !== 'admin').map(u => `<option value="${u.id}">${u.name}</option>`).join('');
        }

        window.deleteUser = async (id) => {
            if (!confirm("Remove this user?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id));
            showToast("User removed");
        };

        window.deleteTask = async (id) => {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id));
            showToast("Task deleted");
        };

        window.toggleModal = (id, show) => {
            document.getElementById(id).classList.toggle('hidden', !show);
        };

        window.openSubmission = (id) => {
            document.getElementById('submit-task-id').value = id;
            window.toggleModal('upload-modal', true);
        };

        window.downloadWork = (name) => {
            showToast("File viewer simulation: " + name);
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            t.classList.remove('translate-y-20');
            setTimeout(() => t.classList.add('translate-y-20'), 3000);
        }

        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            await addDoc(usersRef, {
                name: document.getElementById('new-name').value,
                username: document.getElementById('new-username').value,
                password: document.getElementById('new-password').value,
                role: document.getElementById('new-role').value,
                created: new Date().toISOString()
            });
            window.toggleModal('user-modal', false);
            document.getElementById('user-form').reset();
            showToast("User created");
        });

        document.getElementById('task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const assigneeId = document.getElementById('task-assignee').value;
            const assignee = allUsers.find(u => u.id === assigneeId);
            const tasksRef = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
            
            await addDoc(tasksRef, {
                title: document.getElementById('task-title').value,
                desc: document.getElementById('task-desc').value,
                assigneeId: assigneeId,
                assigneeName: assignee.name,
                status: 'pending',
                date: new Date().toISOString()
            });
            window.toggleModal('task-modal', false);
            document.getElementById('task-form').reset();
            showToast("Task assigned");
        });

        document.getElementById('submission-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('submit-task-id').value;
            const fileInput = document.getElementById('submission-file');
            const file = fileInput.files[0];
            const notes = document.getElementById('submission-notes').value;
            if (!file) return;
            const taskDoc = doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id);
            await updateDoc(taskDoc, {
                status: 'completed',
                fileName: file.name,
                notes: notes,
                submittedAt: new Date().toISOString()
            });
            window.toggleModal('upload-modal', false);
            document.getElementById('submission-form').reset();
            showToast("Task completed");
        });

        initAuth();
    </script>
</body>
</html>
